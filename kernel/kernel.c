/*

Copyright 2024-2026 Amar Djulovic <aaamargml@gmail.com>

This file is part of The Flopperating System.

The Flopperating System is free software: you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version.

The Flopperating System is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with The Flopperating System. If not, see <https://www.gnu.org/licenses/>.

------------------------------------------------------------------------------

kernel.c:

    This is the kernel of The Flopperating System, a free and open-source 32-bit operating system.
    This is the prerelease alpha-v0.1.3 code, still in development.
    It is multiboot compliant, and takes the multiboot info pointer and magic number in kmain.

    kmain(...) called by the boot.asm file and linked to it by the linker.ld file.

    panic(...) is used across the kernel for errors that require a restart.

    halt() uses an infinite while-loop to halt in C. It's not a true cpu halt but it's mainly just for isolating parts of the kernel for debugging


------------------------------------------------------------------------------
*/

#include "kernel.h"
#include "../apps/echo.h"
#include "../drivers/time/floptime.h"
#include "../fs/tmpflopfs/tmpflopfs.h"
#include "../fs/vfs/vfs.h"
#include "../drivers/keyboard/keyboard.h"
#include "../interrupts/interrupts.h"
#include "../lib/str.h"
#include "../lib/assert.h"
#include "../mem/pmm.h"
#include "../mem/utils.h"
#include "../mem/vmm.h"
#include "../mem/gdt.h"
#include "../mem/alloc.h"
#include "../task/sched.h"
#include "../task/process.h"
#include "../drivers/vga/vgahandler.h"
#include "../mem/paging.h"
#include "../lib/logging.h"
#include "../init/init.h"
#include "../multiboot/multiboot.h"
#include "../drivers/vga/framebuffer.h"
#include <stdint.h>
#include "../flanterm/src/flanterm.h"
#include "../flanterm/src/flanterm_backends/fb.h"

void halt() {
    while (1) {
        continue;
    }
}

void cpuhalt() {
    __asm__ volatile("hlt");
}

void panic(uint32_t address, const char* msg, const char* err) {
    const char* art = "%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%####%#%%%%%%%%%%%%%%%%%%%%"
                      "%%%%%%%%%%%%%%%%%%%%%%%%%############################****************\n"
                      "%%%%%%%%%%%%%%%%%%%%%#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#%%%%#%%%%%%%%%%%%%%%%%%%%%%"
                      "%%%%%%%%%%%%%%%%%%%############################*#********************\n"
                      "%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%"
                      "%%%%%%%%%%%%%%###########################*************+++++++********\n"
                      "%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%"
                      "%%%%%%%%%%##########################******************+===++++++++*+\n"
                      "%#%#%#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%"
                      "%%#%#%#####################***********************#%**===++++++++****\n"
                      "#%#%#%##%#%%%%%#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%##"
                      "######################***************************%%%**==+************\n"
                      "##*##################%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%##%#####"
                      "################*******************************##%%#*===*************\n"
                      "####%######################%#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#############"
                      "###########***********************************#%%%**===**************\n"
                      "#%%%%#%##########%%%%%%%%%%%%%%%%%%%%%#%%%%#%#%%%%%%%%%%%%%%%%%%%%%%%%%%%%######################"
                      "####***************************************#%%%%#*+====**************\n"
                      "%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#%#####*#**####################**"
                      "****************************************##%%%#**+=====+**************\n"
                      "%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%###########**#######%######******"
                      "**************************************#%%%%#**+==----=+**************\n"
                      "%%%%%%%%%%%%%%%%%##%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%##############**##*#*#########*******"
                      "**********************************###%%%#***+==-----==++*************\n"
                      "%%%%%%%%%%%%%###%%%%#####%%%%%%%%%%%%%%%%%%%%%%%%%%%#####################**********######**#****"
                      "*****************************#######%##***+==::::-==+++**************\n"
                      "%%%%####************#####******#####%######%%%%%%#################*#***********+***###*#********"
                      "************************###%%%%####*+++++==-:::::=++******+**********\n"
                      "####%%##******+*+*+*******###*******########################***************++++++**#####********"
                      "********************####%#%%%%#*+====+++==-:::::=+**+***+*+*+*++*++++\n"
                      "#####%%##****++++=====+++***###******++**###############******************++++++++****#*#*******"
                      "*****************#%####%%%%%#*===+****+=---::-=++*+**+*****++++++++++\n"
                      "*****#%%#****+++===========+***###******+++*#######***********************+++++++++*************"
                      "**++******+++*+**#######*=======+**+===-:::--==+++*++*+++++*+*++*+*++\n"
                      "******#%%##***+++=============+**#####*****+=++*#####*****************+*++==========----==++****"
                      "+=====-----------:-========+++++*+==-:::::--===++++++++*+++++++++++++\n"
                      "******#%%##****+===============+++***#####***++==+*####**************++============------====+**"
                      "***+====--:::::-===----===++++++==-::::::-===+++++++++++++++++++++*++\n"
                      "*******#%%%#**+*++++=============++++**######**+=====+++*******++++++=====+++=++==-------==-===+"
                      "****+=====-:::::-=+=============-:::::::-=+++++++++++++++++++++++++++\n"
                      "********#%%%#*****++================+++***##%%%%***+=====+*********++**++********==---::---====="
                      "=*#**+=====--:::::=****+=======-::::::::==+++++*+++++++++++++++++++++\n"
                      "****#**#**%%%#*******+++================++**##%%%%####%%%%####************##%%%#**+=-----======="
                      "==*****++==--=-::::=*#%*+=======-:::::::=++++++++++++++++++++++++++++\n"
                      "*********#*#%##************++++===========++**#%%%%%%%%#**###*************#%%%%%%%**=--========="
                      "===+**+++==------:::=#%#+====+++==--:::-=++++++++++++++++++++++++++++\n"
                      "************#%%%##*********#****+++========+****#**######*********#######**##%%%%%%**=====+++**+"
                      "=+++=+**+==-:----::-+#%*==============-=+++++++++++++++++++++++++++++\n"
                      "****#*####****%%%%###*#*#####****===========++*******####*********#######**+**#%@@@%*++==++*++*+"
                      "+===+=++++==-::::::::=+*+===============+++++++++++++++++++==========\n"
                      "**#************#%%%%##********===============++****************#######*#****++**%%@%%**+====+++="
                      "++=+++++====--:::::..:=+++++*++++++=+++==++++++++++==================\n"
                      "***********####**#%%%%#******+**===============++******+*****#*************====+*%#***+========="
                      "====+=+=+=+=--::::...:+#%@@@@@@%**%@%*+++++++========================\n"
                      "******#*######******%%%##********+++++==========*****+++********#*******+=+==+++***+=-----======"
                      "==+=====++++=-::::...:*@@@@@@%*==*#%%+---=-==========================\n"
                      "**#*##*#**************#%%%***********+=========+***+++*************+++++*+****###*#*+--::::--==="
                      "=========+++==:::::..:+%@@@%%@@@%##%*-::-==-:-=======================\n"
                      "************++*+++******%%*++********+========+**+++++***********++*****##%%@@@@@@@@%#+-::::---="
                      "===============::::..:-*%%@@@@@@%%%#=::-====---======================\n"
                      "*****+****++*++*+*+++*+***+=+*********+=====+**++++++++*****##########%%%@@@@@@@%@@@@@%%+-:::--="
                      "===============--:::..-+***%@@@@%#+-::=++===----=====================\n"
                      "++*++*+++++++++++++*+++*+===+***#####**++=++***++++++++++****##%%%%%%##%@@@@@@%%@@@@@@@%%*=:----"
                      "-===============--:::.:=***##*=--::-=**=====-::-=====================\n"
                      "+*+*+++++++++++++++++++++===+*****###********++++**********++==-=*#%%%##%@@@@@@@@@@@@%%%%%*+-::-"
                      "--=============+==-::::-*%%##*=::-===++======-:-====-======-=========\n"
                      "+++++++++++++++++++++++++==+****######*******+++*************+==-::-=+#%%%@@@@@@@@@%%%%%%%%#*=--"
                      "---=========+==----:::::=*%%#*===============-:--====================\n"
                      "++++++++*++++++++++++++++++++*#%%%%%%##*****+++*******************+=-:::-=+***%%%%%%%@%%%@@%#*++"
                      "================----:::--=*#%#*+=============::::-===================\n"
                      "++++++++++*+++++++++++++++++++*#%%%%%%%#****++++******+*++**************++========+#%%%@@@@@%#**"
                      "+++==========--======----=*##***+++=======--::::::-==================\n"
                      "+++++++++++++++++++++++++++++++*#%@@@%%#***=+++********++++*+++**********++****+++****#%%%@@%%%#"
                      "#**+++++++========+=======*%%#****+++======-::::::::-==========-=====\n"
                      "++++++++++++++++++++++++++++++++*%@@@@%#***+**********+++++++++**********+*************#%%%%%%%%"
                      "%%#******++++++===++======+#%%******++++==--:::::::::-===============\n"
                      "+++++++++++++++++++++++++++++++++#%@@%%#**+*************++=++++************************##%%%%%%@"
                      "@@%%###******#*********+=--+#*+===+**++++==-::::::::::-==============\n"
                      "++++++++++++++++++++++++++=======+#%%%##*++*************+++++***********************#####%%%%%%@"
                      "@@@%%%%########*****++++=-::=**=-:--===+++==-::::::::::-=============\n"
                      "+++++++++++++++++++++++++==========++****++*******++++*****+++***********************#*########%"
                      "%%%@%%%%###*####***+++*++=====+==:::::--===-:::::::::::-======--=====\n"
                      "+++++++++++++++++++++++==================+*******+****+*****+++++**************#*#########******"
                      "**#%%%%%%###%%%%#*********#%*+==-:::::::---::::::::::::-==========-=\n"
                      "+++++++++++++++++++++++============-:--==+*****++++==++*************############%%%###*#****++=="
                      "++*#%%%@@%%@@@@@%#***##***#*+-::::::------::::::::::::::-===-=-======\n"
                      "++++++++++++++++++++++====+=++++++=::--==+*****+===+====++***********##%%%%##%%%%####******+===="
                      "==+**#%%@@@@@@@@%%###%%*++==::::::::--=++-:::::::::::::::============\n"
                      "+++++++++++++++******+++++++++++++=:--==++***+++=========++++********#####%%#%####*********++==="
                      "=++=====+*#%%%%%%###*%%%*+=-::::::.:::::--:::::::::::::::============\n"
                      "+++++++++++++*********+*********++=:--==+**++++================++****************************+++"
                      "+++====-----==*#%%%%%%%%%%+-:::::::::::-::::::::-::::::::-===========\n"
                      "++++++++++*****************#******+--====++++++==================++***++++++************####%%%#"
                      "*+=====---:::::-=%%%%%%%%*=::::::::::-===-:::::---:::::::-===========\n"
                      "+++*****************#*************+--==+++**+=======================+=========++*****#%%%%%%%#**"
                      "+======----:::::::=#%%@%#+--::::::::::-===-::::::::::::::-=========-=\n"
                      "+****+****************************+=-===++**+==-=======================---::---==+*%%%%%%%#***+="
                      "+++======------::::-+%%#+======---:-------::::---::::::::-===========\n"
                      "+++++++****+**********************+--===+++*+======================-----::::::--==#%%%%##*******"
                      "###***+===========--=*%*+==++**+========-:::::::::::::::::-========-=\n"
                      "++=+++***+++**********************=--====+++=====================-=-----::::::::--*%%%%%####%%%%"
                      "%%#**+++++++++*****==*%#+===+==+========::::::::::::::::::::-========\n"
                      "+++++++++++*****+*****+***********=---============================-----:::::::::::=%%%%%%%%%%%##"
                      "****######**####**=+*%%%%#*+===========::::::::::::::::::::::-=======\n"
                      "=++++++++++*++++++****************=----======================-----=---::-:::::::---+%%%%%%%%%%%#"
                      "#%%%%%%%#*******++**#****###*+======++-:::::::::::::::::::::::-======\n"
                      "==+++++++***+++**+****************=-----=============++++====-------------::--------=*%%@%@%%%%%"
                      "%%%%%##*******+++***+++++*******=====-:::::::::::::::::::::::::--====\n"
                      "===+++++++**+*+*******************==-========++======++++++=====----====-=---::--====-=+#%%%%%%%"
                      "%%%%%%%%##**+*******++=========-:::::::::::::-:::-::::::::::::::-====\n"
                      "====++++++*********++*************==--========+=======+++========--========-------=---====*#%%%%"
                      "%%%%%%%#***********++==----:-:::::::::::::::::----::---::::::::---===\n";
    log("KERNEL PANIC\n", RED);
    log("SYSTEM ABORTED\n", RED);
    log("CONTACT ADMIN\n", RED);
    echo(art, WHITE);
    log(msg, WHITE);
    log_address("addr: ", address);
    halt();
}

void mem_dump(uint32_t address, uint32_t length) {
    uint32_t* ptr = (uint32_t*) (uintptr_t) address;
    for (uint32_t i = 0; i < length; i++) {
        if (i % 16 == 0) {
            echo("\n", WHITE);
        }
        log_address("", ptr[i]);
    }
    echo("\n", WHITE);
}

void draw_floppaos_logo() {
    const char* ascii_art =
        " _____                                                                        _____ \n"
        "( ___ )----------------------------------------------------------------------( ___ )\n"
        " |   |                                                                        |   | \n"
        " |   |   ________                                                             |   | \n"
        " |   |  /_  __/ /_  ___                                                       |   | \n"
        " |   |   / / / __ \\/ _ \\                                                      |   | \n"
        " |   |  / / / / / /  __/                                                      |   | \n"
        " |   | /_/ /_/ /_/\\___/                                                       |   | \n"
        " |   |     ________                                  __  _                    |   | \n"
        " |   |    / ____/ ____  ____  ____  ___  _________ _/ /_(_____  ____ _        |   | \n"
        " |   |   / /_  / / __ \\/ __ \\/ __ \\/ _ \\/ ___/ __ `/ __/ / __ \\/ __ `/        |   | \n"
        " |   |  / __/ / / /_/ / /_/ / /_/ /  __/ /  / /_/ / /_/ / / / / /_/ /         |   | \n"
        " |   | /_/   /_/\\____/ .___/ .___/\\___/_/   \\__,_/\\__/_/_/ /_/\\__, /          |   | \n"
        " |   |              /_/   /_/                                /____/           |   | \n"
        " |   |    _____            __                                                 |   | \n"
        " |   |   / ___/__  _______/ /____  ____ ___                                   |   | \n"
        " |   |   \\__ \\/ / / / ___/ __/ _ \\/ __ `__ \\                                  |   | \n"
        " |   |  ___/ / /_/ (__  / /_/  __/ / / / / /                                  |   | \n"
        " |   | /____/\\__, /____/\\__/\\___/_/ /_/ /_/   " VERSION "                          |   | \n"
        " |   |      /____/                                                            |   | \n"
        " |___|                                                                        |___| \n"
        "(_____)----------------------------------------------------------------------(_____)\n";

    echo(ascii_art, YELLOW);
    sleep_seconds(2);
}

int kmain(uint32_t magic, multiboot_info_t* mb_info) {
    init(mb_info, default_config);
    echo("The Flopperating System has finished kernel booting! Now we do nothing.\n", GREEN);

    draw_floppaos_logo();
    echo("The Flopperating System, The Flopperating System - Copyright (C) 2024-2026 Amar Djulovic "
         "<aaamargml@gmail.com>\n",
         YELLOW); // copyright notice

    while (1) {
    }
    return 0;
}
